sudo: required
dist: trusty
language: cpp
compiler: gcc

addons:
  apt:
    packages:
    - openmpi-bin
    - libopenmpi-dev
    - libfftw3-dev
    - libnetcdf-dev
    - libhdf5-serial-dev
    - netcdf-bin
    - hdf5-tools

matrix:
  include:
  - env: CONFIGURE_OPTIONS=''
  - addons:
      apt:
        packages:
        - openmpi-bin
        - libopenmpi-dev
        - libfftw3-dev
        - libnetcdf-dev
        - libhdf5-serial-dev
        - netcdf-bin
        - hdf5-tools
        - jq
        - lcov
    env: CONFIGURE_OPTIONS='--enable-code-coverage --enable-debug --enable-checks=3'
    script:
      - wget -O ~/codacy-coverage-reporter-assembly-latest.jar $(curl https://api.github.com/repos/codacy/codacy-coverage-reporter/releases/latest | jq -r .assets[0].browser_download_url)
      - ./configure $CONFIGURE_OPTIONS
      - build-wrapper-linux-x86-64 --out-dir bw-output make -j 2 -k
      - build-wrapper-linux-x86-64 --out-dir bw-output make -j 2 -k check-unit-tests
    after_success:
      - bash <(curl -s https://codecov.io/bash)
      - ./get_code_cov.sh > /dev/null
      - java -cp ~/codacy-coverage-reporter-assembly-latest.jar com.codacy.CodacyCoverageReporter -l Java -r build/reports/jacoco/test/jacocoTestReport.xml
    secure: D4RlEIdLK/XrmXBxKM12VIA8ft7mkytqMb3cMcErF73r0TlCiVrVNON5LeIHcgiJecVeghJhr0s1H24NRDzuuJPO5jNNe8Q+oKQPdCpJLqiYo2voEqKyPIFEbsuffgTRkyNve5o0NuVnZ8j0TL9Q+W1QHubOtYer3fra3+D+/sH+ujyuzdRz97vua9Odxj+KwZFze3ps9RblEfzpb8+fCfiHcrU0Cv3s1DO7IFuyxDWucMWEPQ3bF6B/JEEhwuvIk7FkxXCoIbsC+23uctzL3ZWsX9TBu35nEDNBOM4GZR7HOrHgEc86kCpXloXBBEghYgqw/eiFxAki56ld5B+QTX5ViC9tpBkaqhsK5+hnYGtIZmOyqevMUmg/rS4iTZF2vcuVBZcfkozSV4EaKQFYVD0t9iV9uGsYD1IGUisCVjz3VxfJyIbD31AX9kCK5/RGqipwTsv07u42N+Jr0of6lD10ckLx98CThlKv2XFjwzlvOjuwXUysFhad5apTkWvdyL4PpbRIrJt/nVZZtGvKW/KIfTDlOw3AiJ2AydsLy90ADVEbDWkav5AP8SnKMPbS6sdx1FmxiX96weo6MKED2KnMX7v7Ke6OyK4ELWVjOQf7M8HEFHFyv7VCTKb4TyMJx1zWbZMbBLMIolBSBuUuHFQJ5Dc1HkLHc6+emuan+EM=

before_install:
  ##################################################
  # Job specific setup
  ##################################################
  # The following eval is the way to force CC/CXX to desired values as travis forces values
  # for these in the pre-before_install stage, see https://docs.travis-ci.com/user/languages/cpp/#C11-C%2B%2B11-(and-Beyond)-and-Toolchain-Versioning
  - eval "${MATRIX_EVAL}"
  - echo "${CC} $(${CC} --version)"
  ##################################################
  # Install Conda for python 3
  ##################################################
  - source .install_miniconda_for_travis.sh
  - pip install --user cpp-coveralls

  ##################################################

  # Make sure to use the system NetCDF/HDF5 libraries, or we end up
  # using the Conda libraries, which causes no end of headaches
  - export CONFIGURE_OPTIONS="--with-netcdf=/usr/bin/nc-config --with-hdf5=/usr/bin/h5cc $CONFIGURE_OPTIONS"

script:
  # Configure, compile and run test_suite
  - "./.travis_script.sh"

notifications:
  # Send a notification to the BOUT++ Slack team
  slack:
    secure: keU2ApI8C1M5q1700iNWmhzAQN5iJCciuP6V1lAjVBE8C2C/8mnYK3Pe83wok97buvvfVs5Qjq1+MSYSTCEw+dEye7p+1aBH7qg8C2Jyw+ugFe+6vmijag3v8DqkkzUGyF4X7+ei7YfV4G7u7YAlq/BqzD9e0SA7aASZJ3CF42f4lHKwTe0mnJfqOb8MwCBbSytzdj/iQH/O/pch03CjVObv2A88gaC5YMwYpeTAMMNGZThHsJHcVFCAz4MbvOApKSnykbRbE4AooF6lhUnAg/V40+ews5Q0NhYSLoOcQohLljLTMKAL2oRS34WdunnAEdIighLztFBNI/CKO8uaFBsWZcT2E4qRrajYTnuhCop5fUtk2lsrwUV36WFKLswa74KaSjXgpjvrV1MIidkRztPhYwcJdk9yvEroZ67C4GPBLZ6jZF/nUU9l2toPNkzGkxhDB9r9MIU2l0PJ2d3wRCcZ59jZ/Gr1Bminsyr20AU1JO5tsiO+6UI+7hxXQXtz/1knlmiZ/pXj/3Sp8+KQ/Z0MUeayC0CROFoZt/HekA6z34YcmeN/nMcXCnO7HTZ+bw7LasaIsrHbQ3PYPn8Be2f1hj4sPBnPpruN5FFYYc29c/ek8FET9LLD8a3v1V8P2udy/y5RnDqFskx+OfqKL8tSJk/zSbK/JPCTnx1rfsU=
